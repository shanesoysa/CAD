{% extends 'base.html' %}

{% block title %}Assign Sessions{% endblock title %}

{% block stylesheet %}
<style>
.some {
    line-height: 0.5;
}
@media only screen and (max-width: 600px) {
    .some {
        line-height: 1.5;
    }
}

.left{
    float: left;
    width: 65%;
}
.right{
    float: left;
    width: 35%;
}
.boxed{
    border: 4px dotted purple;
}
.topcornerright{
    position:absolute;
    margin: 12px;
    top: 0;
    right:0;
    color: #33344a;
}

.topcornerleft{
    position:absolute;
    margin: 7px;
    top:0;
    left:0;
    color: #33344a;
}

.code{
    background-color: #FFFFFF;
    color: #800080;
}
</style>
{% endblock stylesheet %}

{% block content %}
<div class="container-fluid main bg-light">
    <div class="bg-light" style="padding: 10px 0px; font-weight: 900;">
        <h3 style="color: #33344a;" >Assign Sessions </h3>
    </div>
    <div class="card shadow p-3 mb-5 bg-white rounded">
        <div class="card-body">
            <form>
                <div class="row">
                    <div class="col form-group">
                        <label for="groupId" class="text-black font-weight-bold">Group</label>
                        <select id="groupId" class="form-control selectpicker" name="group" data-live-search="true">
                            <option value="default" disabled selected>Select Group --</option>
                            {% for group in group_list %}
                            <option value="{{group.id}}">{{ group.generated_group }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col form-group">
                        <label for="lecturerId" class="text-black font-weight-bold">Lecturer</label>
                        <select id="lecturerId" class="form-control selectpicker " name="lecturer" data-live-search="true">
                            <option value="default" disabled selected>Select Lecturer --</option>
                            {% for lecturer in lecturer_list %}
                            <option value="{{lecturer.id}}">{{ lecturer.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col form-group">
                        <label for="subjectId" class="text-black font-weight-bold">Subject</label>
                        <select id="subjectId" class="form-control selectpicker" name="subject" data-live-search="true">
                            <option value="default" disabled selected>Select Subject -- </option>
                            {% for subject in subject_list %}
                            <option value="{{subject.id}}">{{ subject.subjectCode }} - {{ subject.subjectName }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col form-group">
                        <label for="tagId" class="text-black font-weight-bold">Tag</label>
                        <select id="tagId" class="form-control selectpicker" name="tag">
                            <option value="default" disabled selected>Select Tag --</option>
                            {% for tag in tags_list %}
                            <option value="{{tag.id}}">{{ tag.label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row justify-content-md-center">
                    <button onclick="reset()" class="btn btn-secondary col-2">Reset</button> &nbsp;
                    <button id="search_btn" class="btn btn-primary col-2">Search</button>
                </div>
            </form>
        </div>
    </div>
    <div class="container-fluid">
        <div class="left">
            <div class="row" id="sessions_list_id">
                {% for session in session_list %}
                <div class="bg-white col-5 shadow text-black my-4 mr-4 some" id="{{session.id}}">
                    <div>
                        <i class="fas fa-plus topcornerleft add_icon"  data-toggle="tool-tip" title="Assign Session"></i>
                        <i class="fas fa-ellipsis-v topcornerright hamburger_icon dropdown">
                            <div  class="dropdown-menu dropdown-menu-right code shadow">
                                <a class="dropdown-item " href="{% url 'blocked_timeslots' %}">Block Session</a>
                                <a class="dropdown-item " href="{% url 'consecutive_sessions' session.id %}">Set Consecutive</a>
                            </div>
                        </i>
                    </div>

                    <div class="pt-4 pl-4 pr-2 pb-2 m-2">
                        {% if session.group_id %}
                            <p style="font-weight: 500; ">{{ session.group_id.generated_group}}</p>
                        {% else %}
                            <p>{{ session.subgroup_id.generated_subgroup}}</p>
                        {% endif %}
                        <p>{{ session.subject.subjectName}}-{{ session.subject.subjectCode}} <span style="color:{{session.tag.color}};">({{ session.tag.label}})</span></p>
                        <p>{{ session.student_count}} ({{ session.duration}})</p>
                    </div>
                </div> 
                {% endfor%}
            </div>
        </div>
        
        <div class="right">
            <form class=""> 
                <div class="custom-control custom-radio custom-control-inline">
                    <input id="pid1" class="custom-control-input" type="radio" name="parallel" value="true" checked>
                    <label for="pid1" class="custom-control-label">Parallel</label>
                </div>
                <div class="custom-control custom-radio custom-control-inline">
                    <input id="pid2" class="custom-control-input" type="radio" name="parallel" value="false">
                    <label for="pid2" class="custom-control-label">Non Parallel</label>
                </div>
            </form>
            <div class="boxed m-1 p-3">
                <button class="btn btn-primary" style="float: right;"> Save </button>
            </div>
        </div>
    </div>
</div>
{% endblock content %}


{% block javascript%}
<script>
    $(function() {

        $('.hamburger_icon').hover(function(){
            var id = $(this).parent().parent().attr('id');
            showMyMenu(id)
        })

        function showMyMenu(id){
            $('#' + id).find('.dropdown-menu').show();
        }

        $('[data-toggle="tool-tip"]').tooltip();
        // $('.hamburger_icon').mouseover(function(){
            
        // });
        $('.hamburger_icon').mouseleave(function(){
            function hideDrop(){
                $('.dropdown-menu').hide();
            }

            setTimeout(hideDrop, 2000);
        });

        $('.add_icon').click(function(){
            var id = $(this).parent().parent().attr('id')
            console.log('id' + id)
            $('.boxed').prepend($('#' + id).clone().removeClass('col-6').addClass('col-10'))
        });

        $('.boxed > button').click(function(){
            alert('function call')
            var id_list = getSession2IdList();
            var parallel = $('input[type=radio][name=parallel]:checked').val();
            var id_list_json =  JSON.stringify(id_list)
            console.log('parallel' + parallel)
            console.log(id_list)
            console.log(id_list_json)
            $.ajax({
                url: '{% url "add_parallel_sessions"  %}',
                type: 'POST',
                data:{
                    'parallel_session_list': id_list_json,
                    'parallel': parallel,
                },
                dataType:'json',
                success: function(data){
                    if(data.success_stat == 1)
                        window.location.href = '{%url "assign_sessions" %}'
                    else
                        alert(data.error_msg)
                }
            });
        });


        function getSession2IdList(){
            var session_id_list = []
            $('.boxed > div').each((index, val) => session_id_list.push(parseInt(val.id)))
            return session_id_list
        }

        function reset() {
            $("#groupId").val("default");
            $("#lecturerId").val("default");
            $("#subjectId").val("default");
            $("#tagId").val("default");
        }

        $('#search_btn').click(function(e){

            e.preventDefault();
            var group = ($('#groupId').val() != undefined)? $('#groupId').val(): null;
            var tag = ($('#tagId').val() != undefined) ? $('#tagId').val() : null;
            var subject = ($('#subjectId').val() != undefined) ? $('#subjectId').val() : null;
            var lecturer =($('#lecturerId').val() != undefined) ? $('#lecturerId').val() : null;

            $.ajax({
                url: '{% url "search_sessions" %}',
                type: 'POST',
                data: {
                    'lecturer': lecturer,
                    'group': group,
                    'subject': subject,
                    'tag': tag
                },
                dataType: 'json',
                success: function(data) {
                    if(data.success_stat){
                        alert('Method Call is a success');
                        console.log(data.sessions_list)
                        AddSearchedSessions(data.sessions_list)
                    }else{
                        alert(data.error_msg);
                    }
                }
            });
        });

        function AddSearchedSessions(sessions_list){
            $('#sessions_list_id').children().remove();
            console.log(Object.prototype.toString.call(sessions_list))

            sessions_list.forEach(function(session, i){
                if(i == 0){
                    $('#sessions_list_id').prepend(
                    `<div class="bg-white col-5 shadow text-black my-4 mr-4 some" id="${session.id}">
                        <div>
                            <i class="fas fa-plus topcornerleft add_icon"  data-toggle="tool-tip" title="Assign Session"></i>
                            <i class="fas fa-ellipsis-v topcornerright hamburger_icon dropdown">
                                <div  class="dropdown-menu dropdown-menu-right code shadow">
                                    <a class="dropdown-item " href="{% url 'blocked_timeslots' %}">Block Session</a>
                                    <a class="dropdown-item " href="sessions/${session.id}/consecutive">Set Consecutive</a>
                                </div>
                            </i>
                        </div>

                        <div class="pt-4 pl-4 pr-2 pb-2 m-2">
                            <p style="font-weight: 500; ">${session.group != null ? session.group :session.subgroup}</p>
                            <p>${ session.subject_name }-${ session.subject_code} <span style="color:${session.tag_color};">(${ session.tag_label})</span></p>
                            <p>${ session.student_count} (${ session.duration})</p>
                        </div>
                    </div> `
                    );
                }else{
                    $('#sessions_list_id').append(
                    `<div class="bg-white col-5 shadow text-black my-4 mr-4 some" id="${session.id}">
                        <div>
                            <i class="fas fa-plus topcornerleft add_icon"  data-toggle="tool-tip" title="Assign Session"></i>
                            <i class="fas fa-ellipsis-v topcornerright hamburger_icon dropdown">
                                <div  class="dropdown-menu dropdown-menu-right code shadow">
                                    <a class="dropdown-item " href="{% url 'blocked_timeslots' %}">Block Session</a>
                                    <a class="dropdown-item " href="sessions/${session.id}/consecutive">Set Consecutive</a>
                                </div>
                            </i>
                        </div>

                        <div class="pt-4 pl-4 pr-2 pb-2 m-2">
                            <p style="font-weight: 500; ">${session.group != null ? session.group :session.subgroup}</p>
                            <p>${ session.subject_name }-${ session.subject_code} <span style="color:${session.tag_color};">(${ session.tag_label})</span></p>
                            <p>${ session.student_count} (${ session.duration})</p>
                        </div>
                    </div> `
                    );
                }

            });

        }
    });
</script>
{% endblock javascript %}
