{% extends 'base.html' %}


{% block title %}Groups{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card shadow-sm mb-4 bg-white rounded">
        <div class="card-header bg-light text-info">
            <h3>Generate Groups </h3>
        </div>

        <div class="card-body bg-light">
            <div class="card shadow p-3 mb-5 bg-white rounded">
                <form action="" id="addGroup">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group m-4">
                                <label class="text-black font-weight-bold" for="academicsId">Academic year & Semester </label>
                                <select type="text" class="form-control m-3" id="academicsId" name="academics">
                                    <option disabled="true" selected="true"> -- Select Year and Semester </option>
                                    <option value="18">Y2.S1</option>
                                    <option value="19">Y2.S1</option>
                                    <option value="20">Y2.S1</option>
                                    <option value="21">Y2.S1</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="form-group m-4">
                                <label class="font-weight-bold" for="programmeId">Programme </label>
                                <select type="text" class="form-control m-3" id="programmeId" name="programme">
                                    <option disabled="true" selected="true"> -- Programme </option>
                                    <option value="1">IT</option>
                                    <option value="3">DS</option>
                                    <option value="5">ISE</option>
                                    <option value="20"></option>
                                </select>
                            </div>
                        </div>
                        
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group m-4">
                                <label class="text-black font-weight-bold" for="groupId">Group Number </label>
                                <input type="number" class="form-control m-3" min=1 id="groupId" name="group" />
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="form-group m-4">
                                <label class="font-weight-bold" for="countId">Student Count </label>
                                <input type="number" class="form-control m-3" min=1 id="countId" name="count"/>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group m-4" style="float: bottom;">
                                <input type="submit" class="form-control m-3 btn btn-info btn-block" value="  Add  " />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        
            <div class="card shadow p-3 mb-5 bg-white rounded">


                <table class="table" id="groupTb">
                    <thead>
                      <tr>
                        <th scope="col">Acadmic Year Semester</th>
                        <th scope="col">Programme</th>
                        <th scope="col">Group No</th>
                        <th scope="col">Student Count</th>
                        <th scope="col"></th>
                      </tr>
                    </thead>
                    <tbody>
                    {% for group in group_list %}
                      <tr id="sg-{{group.id}}">
                        <th scope="row" class="yearSem userData" name="pname">{{ group.academic_year_semester }}</th>
                        <th scope="row" class="Pro userData" name="pname">{{ group.programme }}</th>
                        <th scope="row" class="grouNo userData" name="pname">{{ group.group_no }}</th>
                        <td class="groupCount userData" name="pabbv">{{group.student_count}}</td>
                        <td><pre><span onClick="editGroup({{group.id}})" data-toggle="modal" data-target="#myModal"><i class="fas fa-pencil-alt"></i></span>  <span onclick="deleteGroup({{group.id}})"><i class="far fa-trash-alt" style="color:purple;"></i></span></h5></pre></td>
                      </tr>
                    {% endfor %}  
                    </tbody>
                  </table>
            </div>
        </div>
    </div>
</div>

 <!-- Modal -->
 <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
          <h4 class="modal-title" id="myModalLabel">Update Programme</h4>
        </div>
        <form id="updateProgramme" action="">
            <div class="modal-body">
                <input class="form-control" id="form-id" type="hidden" name="formId"/>
                <label for="name">Programme</label>
                <input class="form-control" id="form-name" type="text" name="formName"/>
                <label for="address">Abbreviation</label>
                <input class="form-control" id="form-abbv" type="text" name="formAbbv"/>
                
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary" >Save changes</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </form>
      </div>
    </div>
</div>
{% endblock %}


{% block javascript %}
<script>

    $("form#addGroup").submit(function() {
    
        var gacademics = $('#academicsId').val();
        var gprogramme = $('#programmeId').val();
        var ggroup = $('input[name="group"]').val();
        var gcount = $('input[name="count"]').val();
       
        console.log('dropdown: ' + gacademics + ' ' + gprogramme)
        if (gacademics && gprogramme && ggroup && gcount) {
            // Create Ajax Call
            $.ajax({
                url: '{% url "add_groups" %}',
                data: {
                'academic_year_semester':gacademics,
                'programme':gprogramme,
                'group_no':ggroup,
                'student_count':gcount
                },
                dataType: 'json',
                success: function (data) {
                
                    console.log(data.student);
    
                    if (data.student) {
                    appendToUsrTable(data.student);
                    alert("Data Added")
                    
                    }
                    
                }
            });
        } else {
            alert("All fields must have a valid value.");
        }
        $('form#addGroup').trigger("reset");
        return false;
    });
    
    function appendToUsrTable(group) {
        $("#groupTb > tbody:last-child").append(`
             <tr id="sg-${group.id}">
                <th scope="row" class="yearSem userData" name="pname">${group.academic_year_semester}</th>
                <th scope="row" class="Pro userData" name="pname">${group.programme }</th>
                <th scope="row" class="grouNo userData" name="pname">${group.generated_group}</th>
                <td class="groupCount userData" name="pabbv">${programme.student_count}</td>
                <td><pre><span onClick="editGroup(${group.id})" data-toggle="modal" data-target="#myModal"><i class="fas fa-pencil-alt"></i></span>  <span onclick="deleteGroup(${group.id})"><i class="far fa-trash-alt" style="color:purple;"></i></span></h5></pre></td>
            </tr>
          `);
      }
    
    function deleteGroup(id) {
      var action = confirm("Are you sure you want to delete ?");
      if (action != false) {
        $.ajax({
            url: '{% url "remove_groups" %}',
            data: {
                'id': id,
            },
            dataType: 'json',
            success: function (data) {
                
                if (data.deleted) {
                  $("#groupTb #sg-" + id).remove();
                }
            }
        });
      }
    }
    
    
    $("form#updateProgramme").submit(function() {
    
    var idInput = $('input[name="formId"]').val().trim();
    var nameInput = $('input[name="formName"]').val();
    var abbvInput = $('input[name="formAbbv"]').val().trim();
    
    
    if (nameInput && abbvInput) {
        // Create Ajax Call
        $.ajax({
            url: '{% url "update_programmes" %}',
            data: {
              'id':idInput,
              'programme_name':nameInput,
              'programme_abbv':abbvInput,
            },
            dataType: 'json',
            success: function (data) {
                if (data.programme) {
                  
                  updateToUserTabel(data.programme);
                  
                }
            }
        });
       } else {
        alert("All fields must have a valid value.");
    }
    
    $('form#updateProgramme').trigger("reset");
    $('#myModal').modal('hide');
    return false;
    });
    
    
    function editProgramme(id) {
      
      if (id) {
      
      tr_id = "#pr-" + id;
      pname = $(tr_id).find(".proName").text();
      pabbv = $(tr_id).find(".proAbbv").text();
      
      $('#form-id').val(id);
      $('#form-name').val(pname);
      $('#form-abbv').val(pabbv);
    
      }
    }
    
    function updateToUserTabel(programme){
    $("#programmeTable #pr-" + programme.id).children(".userData").each(function() {
        var attr = $(this).attr("name");
        if (attr == "pname") {
          $(this).text(programme.programme_name);
        } else if (attr == "pabbv") {
          $(this).text(programme.programme_abbv);
        } 
      });
    }
    
</script>
{% endblock javascript %}